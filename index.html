<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·∫°o n·ªôi dung b√†n giao</title>

    <!-- Export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <style>
        :root {
            --brand-primary: #0d6efd;
            --brand-hkd: #22c55e;
            --brand-easybook: #897a19;
            --brand-easypos: #511989;
            --brand-tax: #891919;
            --border: #ddd;
            --danger: #dc2626;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .08);
        }

        h2,
        h3 {
            margin-top: 0
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px 40px;
        }

        label {
            font-weight: 600;
            font-size: 14px
        }

        input {
            width: 96%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
        }

        hr {
            margin: 24px 0
        }

        .type-select {
            display: flex;
            gap: 14px;
        }

        .type-option {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid var(--border);
            cursor: pointer;
            text-align: center;
            font-weight: 600;
        }

        .type-option input {
            display: none
        }

        .type-option:has(input:checked[value="HKD"]) {
            border-color: var(--brand-hkd);
            background: #f0fff5;
            color: var(--brand-hkd);
        }

        .type-option:has(input:checked[value="DN"]) {
            border-color: var(--brand-primary);
            background: #f0f7ff;
            color: var(--brand-primary);
        }

        .display-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .display-item {
            padding: 14px;
            border-radius: 12px;
            border: 2px solid var(--border);
            cursor: pointer;
            background: #fafafa;
            text-align: center;
        }

        .display-item input {
            display: none
        }

        .display-item:has(input:checked) {
            border-color: var(--brand-primary);
            background: #f0f7ff;
        }

        .display-item.payment:has(input:checked) {
            border-color: var(--brand-hkd);
            background: #f0fff5;
        }

        .display-item.easybook:has(input:checked) {
            border-color: var(--brand-easybook);
            background: #fffff0;
        }

        .display-item.easypos:has(input:checked) {
            border-color: var(--brand-easypos);
            background: #f0f7ff;
        }

        .display-item.tax:has(input:checked) {
            border-color: var(--brand-tax);
            background: #fff0f0;
        }

        .preview {
            background: #f9fafb;
            border-radius: 14px;
            padding: 20px;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            font-size: 14px;
            line-height: 1.6;
        }

        .title {
            font-weight: 700;
            color: var(--danger);
            display: block;
            margin: 8px 0 4px;
        }

        .divider {
            color: #999;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-copy {
            background: #0d6efd;
            color: #fff
        }

        @media(max-width:700px) {

            .grid,
            .display-options {
                grid-template-columns: 1fr
            }
        }

        textarea {
            width: 96%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            resize: vertical;
            /* cho k√©o cao th·∫•p */
            font-family: inherit;
        }

        input.error {
            border: 1px solid red;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>üìÑ T·∫°o n·ªôi dung b√†n giao</h2>

        <div class="type-select">
            <label class="type-option">
                <input type="radio" name="type" value="HKD" checked> H·ªô kinh doanh
            </label>
            <label class="type-option">
                <input type="radio" name="type" value="DN"> Doanh nghi·ªáp
            </label>
        </div>

        <hr>
        <div id="mstError"
            style="color:red;font-size: 15px;margin-top: -15px;margin-bottom: 14px;display:none;font-weight: bold;">
        </div>
        <div id="emailError" class="error-text"
            style="color:red;font-size: 15px;margin-top: -15px;margin-bottom: 14px;display:none;font-weight: bold;">
        </div>

        <div class="grid">
            <div><label>M√£ s·ªë thu·∫ø</label><input id="mst"></div>
            <div><label>T√™n HKD / DN</label><input id="company"></div>
            <div><label id="labelChu">Ch·ªß h·ªô kinh doanh</label><input id="owner"></div>
            <div><label>S·ªë ƒëi·ªán tho·∫°i</label><input id="phone"></div>
            <div><label>Email</label><input id="email"></div>
            <div><label>ƒê·ªãa ch·ªâ</label><input id="address"></div>
            <div><label>S·ªë ti·ªÅn ph·∫£i tr·∫£</label><input id="payAmount" type="number"></div>
            <div><label>N·ªôi dung thanh to√°n</label><input id="payContent"></div>
            <div>
                <label for="note">Ghi ch√∫</label>
                <textarea id="note" rows="16" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
            </div>
            <!-- ‚úÖ TH√äM INPUT PASTE QR (C√ÅCH 1) -->
            <div>
                <label>D√°n h√¨nh m√£ QR (Ctrl + V)</label>
                <input id="qrPaste" placeholder="Click v√†o ƒë√¢y r·ªìi Ctrl + V h√¨nh QR">
                <img id="qrPreview" style="display:none;max-width:200px;margin-top:8px;border-radius:8px;">
            </div>

        </div>

        <hr>

        <h3>Hi·ªÉn th·ªã n·ªôi dung</h3>
        <div class="display-options">
            <label class="display-item"><input type="checkbox" id="chkInvoice"> EasyInvoice</label>
            <label class="display-item easypos"><input type="checkbox" id="chkPos"> EasyPOS</label>
            <label class="display-item easybook"><input type="checkbox" id="chkBook"> EasyBook</label>
            <label class="display-item payment"><input type="checkbox" id="chkPay"> Thanh to√°n</label>
            <label class="display-item tax" id="taxWrapper" style="display:none">
                <input type="checkbox" id="chkTax"> Thu·∫ø ƒëi·ªán t·ª≠
            </label>
        </div>

        <hr>

        <h3>Xem tr∆∞·ªõc</h3>
        <div class="preview">
            <div class="card" id="content"></div>
            <div class="actions">
                <button class="btn-copy" onclick="copyAll()">üìã Copy Zalo format</button>
                <button class="btn-copy" style="background:#dc2626" onclick="exportPDF()">üìÑ Xu·∫•t PDF</button>
            </div>
        </div>
    </div>

    <script>
        /* ================= GLOBAL ================= */
        let lastMST = "";
        const mstError = document.getElementById("mstError");
        const els = document.querySelectorAll("input");

        /* ================= INPUT RENDER ================= */
        els.forEach(e => e.addEventListener("input", render));

        /* ================= TYPE CHANGE ================= */
        document.querySelectorAll('input[name="type"]').forEach(r =>
            r.addEventListener("change", () => {
                labelChu.textContent = r.value === "DN"
                    ? "Ng∆∞·ªùi ƒë·∫°i di·ªán ph√°p lu·∫≠t"
                    : "Ch·ªß h·ªô kinh doanh";

                clearMSTError();

                if (mst.value.trim()) {
                    validateMST(); // ki·ªÉm tra l·∫°i khi ƒë·ªïi DN / HKD
                }

                toggleTaxCheckbox();
                render();
            })
        );

        /* ================= RESET FORM ================= */
        function resetFormByMST() {
            company.value = "";
            owner.value = "";
            phone.value = "";
            email.value = "";
            address.value = "";
            note.value = "";
            render();
            clearEmailError();
        }

        /* ================= VALIDATE MST ================= */
        function validateMST() {
            const tax = mst.value.trim();
            const typeEl = document.querySelector('input[name="type"]:checked');
            if (!tax || !typeEl) return true;

            const type = typeEl.value;

            if (type === "DN" && tax.length !== 10) {
                showMSTError("Doanh nghi·ªáp ph·∫£i c√≥ M√£ s·ªë thu·∫ø 10 s·ªë");
                return false;
            }

            if (type === "HKD" && tax.length !== 12) {
                showMSTError("H·ªô kinh doanh ph·∫£i c√≥ M√£ s·ªë thu·∫ø 12 s·ªë");
                return false;
            }

            clearMSTError();
            return true;
        }

        /* ================= CLEAR ERROR WHEN TYPING ================= */
        mst.addEventListener("input", clearMSTError);
        email.addEventListener("input", clearEmailError);

        email.addEventListener("blur", () => {
            if (email.value && !isValidEmail(email.value)) {
                showEmailError("Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng email");
            } else {
                clearEmailError();
            }
        });

        /* ================= MST BLUR ================= */
        mst.addEventListener("blur", async () => {
            const tax = mst.value.trim();

            clearMSTError();
            if (!tax) return;

            // ‚ùå Sai MST ‚Üí kh√¥ng tra API
            if (!validateMST()) return;

            // MST thay ƒë·ªïi ‚Üí reset form
            if (tax !== lastMST) {
                resetFormByMST();
                lastMST = tax;
            }

            try {
                let found = false;

                /* ================= 1Ô∏è‚É£ VIETQR ================= */
                const resVietQR = await fetch(
                    `https://api.vietqr.io/v2/business/${tax}`
                );

                if (resVietQR.ok) {
                    const jsonVietQR = await resVietQR.json();

                    if (jsonVietQR.code === "00" && jsonVietQR.data) {
                        const d = jsonVietQR.data;

                        if (d.name) company.value = d.name;
                        if (d.address) address.value = d.address;
                        if (d.phone) phone.value = d.phone;

                        found = true;
                    }
                }

                /* ================= 2Ô∏è‚É£ XINVOICE (FALLBACK) ================= */
                if (!found) {
                    const resGDT = await fetch(
                        `https://api.xinvoice.vn/gdt-api/tax-payer/${tax}`
                    );

                    if (resGDT.ok) {
                        const jsonGDT = await resGDT.json();

                        if (jsonGDT.name) company.value = jsonGDT.name;
                        if (jsonGDT.address) address.value = jsonGDT.address;
                        if (jsonGDT.legalRepresentative)
                            owner.value = jsonGDT.legalRepresentative;
                    }
                }

                render();
            } catch (e) {
                showMSTError("Kh√¥ng th·ªÉ tra c·ª©u M√£ s·ªë thu·∫ø. Vui l√≤ng th·ª≠ l·∫°i");
                console.error(e);
            }
        });

        /* ================= RENDER ================= */
        function line(title) {
            return `<div class="divider">----------------------------------------</div>
    <span class="title">${title}</span>`;
        }

        function render() {
            const typeEl = document.querySelector('input[name="type"]:checked');
            if (!typeEl) {
                content.innerHTML = "";
                return;
            }

            const type = typeEl.value;
            const passEI = type === "HKD" ? mst.value : "pass!@#$%";

            let html = type === "DN"
                ? line("TH√îNG TIN DOANH NGHI·ªÜP")
                : line("TH√îNG TIN H·ªò KINH DOANH");

            html += `
${company.value}<br>
MST: ${mst.value}<br>
${labelChu.textContent}: ${owner.value}<br>
ƒê·ªãa ch·ªâ: ${address.value}<br>
SƒêT: ${phone.value}<br>
Email: ${email.value}<br>
Ghi ch√∫: ${note.value}<br>
`;

            if (chkInvoice.checked) {
                html += `${line("PH·∫¶N M·ªÄM EASYINVOICE")}
https://app.easyinvoice.vn<br>
MST: ${mst.value}<br>
TK: ${mst.value}<br>
MK: ${passEI}<br>`;
            }

            if (chkPos.checked) {
                html += `${line("PH·∫¶N M·ªÄM EASYPOS")}
https://app.easypos.vn<br>
TK: ${phone.value}<br>
MK: Epos@123<br>`;
            }

            if (chkBook.checked) {
                html += `${line("PH·∫¶N M·ªÄM EASYBOOK")}
https://app88.easybooks.vn<br>
Email nh·∫≠n th√¥ng tin: ${email.value}<br>`;
            }

            if (type === "DN" && chkTax.checked) {
                html += `${line("THU·∫æ ƒêI·ªÜN T·ª¨")}
TK: ${mst.value}-ql<br>
MK: tct@123<br>`;
            }

            if (chkPay.checked) {
                const money = payAmount.value
                    ? Number(payAmount.value).toLocaleString("vi-VN")
                    : "";

                html += `
${line("TH√îNG TIN THANH TO√ÅN")}

<div style="display:flex;gap:16px;align-items:flex-start;">
    <div style="flex:1">
        S·ªë t√†i kho·∫£n: V2SD08112998<br>
        T√™n t√†i kho·∫£n: CTY CO PHAN DAU TU CONG NGHE VA THUONG MAI SOFTDREAMS<br>
        Ng√¢n h√†ng: BIDV CN Thanh Xu√¢n<br>
        S·ªë ti·ªÅn ph·∫£i tr·∫£: ${money}<br>
        N·ªôi dung: ${payContent.value}<br>
    </div>

    ${window.qrImageBase64
                        ? `<div style="width:200px;text-align:center">
            <img src="${window.qrImageBase64}"
                 style="width:140px;height:auto;margin-top:-31px">
           </div>`
                        : ``}
</div>`;
            }

            content.innerHTML = html;
        }

        /* ================= COPY ================= */
        function copyAll() {
            const text = content.innerText
                .split("\n")
                .map(l => l.trimStart())
                .join("\n")
                .trim();

            navigator.clipboard.writeText(text);
            alert("ƒê√£ copy n·ªôi dung ƒë·ªÉ g·ª≠i Zalo ‚úÖ");
        }

        /* ================= QR PASTE ================= */
        const qrPaste = document.getElementById("qrPaste");
        const qrPreview = document.getElementById("qrPreview");

        qrPaste.addEventListener("paste", e => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.includes("image")) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = () => {
                        qrPreview.src = reader.result;
                        qrPreview.style.display = "block";
                        window.qrImageBase64 = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        /* ================= PDF ================= */
        async function exportPDF() {
            const { jsPDF } = window.jspdf;

            const header = document.createElement("div");
            header.style.textAlign = "center";
            header.style.marginBottom = "10px";

            const logo = new Image();
            logo.src = "./logo-softdream-02.png";
            logo.style.height = "60px";
            logo.style.display = "block";
            logo.style.margin = "0 auto 8px";

            const title = document.createElement("div");
            title.innerHTML = `
        <div style="font-size:18px;font-weight:700">BI√äN B·∫¢N B√ÄN GIAO</div>
        <div style="font-size:15px;color:#555">Ph·∫ßn m·ªÅm & th√¥ng tin s·ª≠ d·ª•ng</div>
    `;

            header.appendChild(logo);
            header.appendChild(title);

            const bodyClone = content.cloneNode(true);
            bodyClone.style.boxShadow = "none";
            bodyClone.style.borderRadius = "0";

            const wrapper = document.createElement("div");
            wrapper.style.position = "fixed";
            wrapper.style.left = "-10000px";
            wrapper.style.top = "0";
            wrapper.style.width = "794px";
            wrapper.style.padding = "15px";
            wrapper.style.background = "#fff";
            wrapper.style.fontFamily = "system-ui, sans-serif";

            wrapper.appendChild(header);
            wrapper.appendChild(bodyClone);
            document.body.appendChild(wrapper);

            await new Promise(r => {
                logo.onload = r;
                logo.onerror = r;
            });

            const canvas = await html2canvas(wrapper, {
                scale: 2,
                backgroundColor: "#fff",
                windowWidth: 794,
                windowHeight: wrapper.scrollHeight
            });

            document.body.removeChild(wrapper);

            const pdf = new jsPDF("p", "mm", "a4");
            const pageW = 210;
            const pageH = 297;

            const imgW = pageW;
            const imgH = (canvas.height * imgW) / canvas.width;
            const finalH = Math.min(imgH, pageH - 20);

            pdf.addImage(
                canvas.toDataURL("image/jpeg", 1),
                "JPEG",
                0,
                0,
                imgW,
                finalH
            );

            pdf.save(`bien-ban-ban-giao-${mst.value || "khach-hang"}.pdf`);
        }

        /* ================= TOGGLE TAX ================= */
        function toggleTaxCheckbox() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const taxWrapper = document.getElementById("taxWrapper");

            if (type === "DN") {
                taxWrapper.style.display = "block";
            } else {
                taxWrapper.style.display = "none";
                chkTax.checked = false;
            }
        }

        /* ================= ERROR UI ================= */
        function showMSTError(msg) {
            mstError.textContent = msg;
            mstError.style.display = "block";
            mst.classList.add("error");
        }

        function clearMSTError() {
            mstError.textContent = "";
            mstError.style.display = "none";
            mst.classList.remove("error");
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        const emailError = document.getElementById("emailError");

        function showEmailError(msg) {
            emailError.textContent = msg;
            emailError.style.display = "block";
            email.classList.add("error");
        }

        function clearEmailError() {
            emailError.textContent = "";
            emailError.style.display = "none";
            email.classList.remove("error");
        }



        /* ================= INIT ================= */
        toggleTaxCheckbox();
        render();
    </script>

</body>

</html>